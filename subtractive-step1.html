<!--
  Tutorial 1: Subtractive Synthesizer, Step 1
-->

<!doctype html>
<html>

<head>
  <title>Tutorial: Subtractive Synth | MOTW 2015</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <link rel="import" href="assets/motw-doc-header.html">
</head>

<body>
  
  <div class="info">
    <h1>Subtractive Synthesizer</h1>
    <h2>Step 1</h2>
    <p class="description">A simple subtractive synthesizer with few controls.</p>
    <ol>
      <li>Creating an audiograph for subtractive synthesis.</li>
      <li>Use <code>keydown</code> event to trigger the change of oscillator's pitch.</li>
      <li>Bind UI components to the associated <code>AudioParams</code>.</li>
    </ol>
  </div>

  <div class="workspace">
    <spiral-knob id="k-cutoff" label="Cutoff" value="250" min-value="60" max-value="1000"></spiral-knob>
    <spiral-knob id="k-reso" label="Reso" value="1.0" min-value="0.1" max-value="20"></spiral-knob>
    <spiral-knob id="k-amp" label="Amp" value="0.0" min-value="0.0" max-value="1.0"></spiral-knob>
  </div>

  <div id="code-viewer">
  </div>
  
<script id="tutorial-code">
window.addEventListener('WebComponentsReady', function () {
  
  /**
   * Step 1: Creating an audiograph for the subtractive synthesis.
   *
   * Subtractive synthesis starts with a rich tone and cut out the spectral
   * content you do not need. A sawtooth oscillator and a low pass filter is a 
   * typical combination for the task.
   */

  var context = new AudioContext();
  var sawosc = context.createOscillator();
  var lowpass = context.createBiquadFilter();
  var amp = context.createGain();

  // Define the waveform type and set up the cutoff frequency.
  sawosc.type = 'sawtooth';
  lowpass.frequency.value = 1000;
  amp.gain.value = 0.0;

  // Creates audio graph and starts the oscillator.
  sawosc.to(lowpass).to(amp).to(context.DAC);
  sawosc.start();


  /**
   * Step 2: Use |keydown| event to trigger the change of oscillator's pitch.
   *
   * Convert the key code from the key event to MIDI pitch. Then convert it again
   * to the frequency for the oscillator. 
   *
   * Q) Can you implement noteOn/noteOff like a monophonic synthesizer?
   */


  // Key-to-Pitch map: The key code to the MIDI pitch.
  //  w e   t y u
  // a s d f g h j k
  var KEY2PITCH = {
    '65': 60,   // C4
    '87': 61,   // C#4
    '83': 62,   // D4
    '69': 63,   // D#4
    '68': 64,   // E4
    '70': 65,   // F4
    '84': 66,   // F#4
    '71': 67,   // G4
    '89': 68,   // G#4
    '72': 69,   // A4
    '85': 70,   // A#4
    '74': 71,   // B4
    '75': 72    // C5
  };

  // Key event handler: change the oscillator's frequency.
  window.addEventListener('keydown', function (event) {
    if (!KEY2PITCH.hasOwnProperty(event.keyCode))
      return;

    // Get MIDI pitch from the key code and convert it to frequency.
    sawosc.frequency.value = Spiral.mtof(KEY2PITCH[event.keyCode]);
  });


  /**
   * Step 3: Bind UI components to the associated AudioParams.
   *
   * This step is very easy with Spiral UI elements. However, can you achieve
   * the same functionality with the vanilla <input> element?
   */

  var knobCutoff = document.getElementById('k-cutoff');
  var knobReso = document.getElementById('k-reso');
  var knobAmp = document.getElementById('k-amp');

  knobCutoff.bind(lowpass.frequency);
  knobReso.bind(lowpass.Q);
  knobAmp.bind(amp.gain);

});
</script>

</body>

</html>