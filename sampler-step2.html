<!--
  Tutorial 1: Sampler, Step 2
-->

<!doctype html>
<html>

<head>
  <title>Tutorial: Sampler | MOTW 2015</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <link rel="import" href="assets/motw-doc-header.html">
</head>

<body>
  
  <div class="info">
    <h1>Sampler</h1>
    <h2>Step 2: Drum Sampler</h2>
    <p class="description">A simple PCM sampler with few controls.</p>
    <ol>
      <li>Create <code>SampleVoice</code> class for the individual sample playback.</li>
      <li>Use <code>keydown</code> event to trigger different samples with the associated key.</li>
      <li>Create a <code>Sampler</code> singleton object for the application.</li>
    </ol>
  </div>

  <div class="workspace">
    <spiral-knob id="k-cutoff" label="Cutoff" value="750" min-value="60" max-value="3000"></spiral-knob>
    <spiral-knob id="k-reso" label="Reso" value="2.0" min-value="0.1" max-value="20"></spiral-knob>
    <spiral-knob id="k-amp" label="Amp" value="0.75" min-value="0.0" max-value="1.0"></spiral-knob>
  </div>

  <div id="code-viewer">
  </div>
  
<script id="tutorial-code">

// SampleVoice class.
function SampleVoice(context, buffer) {
  this.context = context;
  this.buffer = buffer;

  context.createNodes(this, {
    src: 'BufferSource',
    lpf: 'BiquadFilter',
    amp: 'Gain'
  });

  this.src.to(this.lpf).to(this.amp);
  this.src.buffer = buffer;
}

SampleVoice.prototype.to = function (destination) {
  return this.amp.to(destination);
};

SampleVoice.prototype.setFilter = function (cutoff, reso) {
  this.lpf.frequency.value = cutoff;
  this.lpf.Q.value = reso;
};

SampleVoice.prototype.noteOn = function (intensity, when) {
  this.amp.gain.value = intensity;
  this.src.start(when);
  this.src.stop(when + this.src.buffer.duration);
};



// Application object.
var Sampler = {
  
  context: new AudioContext(),
  
  controls: null,

  buffers: null,

  audioFiles: [
    { name: 'kick', url: 'sounds/kd-001.mp3' }, 
    { name: 'snare', url: 'sounds/sd-001.mp3' }, 
    { name: 'hihat', url: 'sounds/hh-001.mp3' }
  ],
  
  keymap: {
    '16': 'kick',     // shift
    '13': 'snare',    // enter
    '190': 'hihat',   // period  
    '191': 'hihat',   // period  
  },

  initialize: function (buffers) {
    
    this.buffers = buffers;
    
    // Start listening the keydown event.
    window.addEventListener('keydown', function (event) {
      if (!this.keymap.hasOwnProperty(event.keyCode))
        return;

      var buffer = this.buffers.get(this.keymap[event.keyCode]);
      var sampleVoice = new SampleVoice(this.context, buffer);
      sampleVoice.setFilter(this.controls.cutoff.getValue(), this.controls.reso.getValue());
      sampleVoice.to(this.context.DAC);
      sampleVoice.noteOn(this.controls.amp.getValue(), this.context.now);
    }.bind(this));
  },

  loadResources: function () {
    this.context.loadAudioFiles(this.audioFiles, function() {}).then(
       this.initialize.bind(this), function () {});
  }

};


// Entry point.
window.addEventListener('WebComponentsReady', function () {

  Sampler.controls = {
    cutoff: document.getElementById('k-cutoff'),
    reso: document.getElementById('k-reso'),
    amp: document.getElementById('k-amp'),
  };

  Sampler.loadResources();

});
</script>

</body>

</html>