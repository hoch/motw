<!--
  Tutorial 1: Subtractive Synthesizer, Step 3
-->

<!doctype html>
<html>

<head>
  <title>Tutorial: Subtractive Synth | MOTW 2015</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <link rel="import" href="assets/motw-doc-header.html">
</head>

<body>
  
  <div class="info">
    <h1>Subtractive Synthesizer</h1>
    <h2>Step 3</h2>
    <p class="description">Design a multi-oscillator polyphonic synthesizer with effects.</p>
    <ol>
      <li>Expand <code>Voice</code> class for the multi-oscillator with detune.</li>
      <li>Implement ADSR envelope with note on/off.</li>
      <li>Add the global feedback delay effect.</li>
    </ol>
  </div>

  <div class="workspace">
    <spiral-knob id="k-cutoff" label="Cutoff" value="500" min-value="125" max-value="5000"></spiral-knob>
    <spiral-knob id="k-reso" label="Reso" value="12.0" min-value="0.1" max-value="36"></spiral-knob>
    <div class="param-divider"></div>
    <spiral-knob id="k-attack" label="Attack" value="0.02" min-value="0.01" max-value="0.25"></spiral-knob>
    <spiral-knob id="k-decay" label="Decay" value="0.1" min-value="0.01" max-value="1.0"></spiral-knob>
    <spiral-knob id="k-sustain" label="Sustain" value="0.35" min-value="0.0" max-value="1.0"></spiral-knob>
    <spiral-knob id="k-release" label="Release" value="0.35" min-value="0.01" max-value="5.0"></spiral-knob>
    <div class="param-divider"></div>
    <spiral-knob id="k-mix" label="Mix" value="0.25" min-value="0.0" max-value="1.0"></spiral-knob>
    <spiral-knob id="k-delay" label="Delay Time" value="0.125" min-value="0.005" max-value="3.0"></spiral-knob>
    <spiral-knob id="k-feedback" label="Feedback" value="0.35" min-value="0.01" max-value="0.99"></spiral-knob>
  </div>

  <div id="code-viewer">
  </div>
  
<script id="tutorial-code">

/**
 * Step 1: Expand Voice class with multi-oscillator with detune.
 */
function Voice(context, masterEffect) {
  this.context = context;

  context.createNodes(this, {
    osc1: 'Oscillator',
    osc2: 'Oscillator',
    osc3: 'Oscillator',
    bal1: 'Gain',
    bal2: 'Gain',
    bal3: 'Gain',
    lpf: 'BiquadFilter',
    amp: 'Gain'
  });
  
  this.osc1.to(this.bal1).to(this.lpf).to(this.amp);
  this.osc2.to(this.bal2).to(this.lpf);
  this.osc3.to(this.bal3).to(this.lpf);

  this.osc1.type = this.osc2.type = this.osc3.type = 'sawtooth';

  // Experiment: detuning and balancing.
  this.osc2.detune.value = -1190;
  this.osc3.detune.value = 1210;
  this.bal1.gain.value = 0.75;
  this.bal2.gain.value = 0.5;
  this.bal3.gain.value = 0.5;
}

Voice.prototype.setFilter = function (cutoff, reso) {
  this.lpf.frequency.value = cutoff;
  this.lpf.Q.value = reso;
};

Voice.prototype.to = function (destination) {
  this.amp.to(destination);
};

/**
 * Step 2: Implement ADSR envelope.
 */
Voice.prototype.noteOn = function (pitch, params) {
  var freq = Spiral.mtof(pitch);
  var now = this.context.now;

  // Setting the oscillator pitch.
  this.osc1.frequency.setValueAtTime(freq, now);
  this.osc2.frequency.setValueAtTime(freq, now);
  this.osc3.frequency.setValueAtTime(freq, now);

  this.amp.gain.setValueAtTime(0.0, now);
  this.amp.gain.linearRampToValueAtTime(params.intensity, now + params.attack);
  this.amp.gain.linearRampToValueAtTime(params.sustain, now + params.attack + params.decay);

  this.osc1.start(now);
  this.osc2.start(now);
  this.osc3.start(now);
};

Voice.prototype.noteOff = function (release) {
  var now = this.context.now;
  this.amp.gain.linearRampToValueAtTime(0.0, now + release);
  this.osc1.stop(now + release);
  this.osc2.stop(now + release);
  this.osc3.stop(now + release);
};


/**
 * Step 3: Global Echo effect processor.
 */
function EchoProcessor(context) {

  context.createNodes(this, {
    'input': 'Gain',
    'wet': 'Gain',
    'dry': 'Gain',
    'dly': 'Delay',
    'fbk': 'Gain',
    'output': 'Gain'
  });

  this.input.to(this.wet, this.dry);
  this.wet.to(this.dly).to(this.fbk).to(this.dly).to(this.output);
  this.dry.to(this.output);

  this.dly.delayTime.value = 0.5;
  this.fbk.gain.value = 0.5;
};

EchoProcessor.prototype.to = function (destination) {
  this.output.to(destination);
};


function KeyEventHandler(context, effect, controls) {

  this.context = context;
  this.effect = effect;
  this.controls = controls;

  this.KEYS_PRESSED = [];
  this.KEY2PITCH = {
    '65': 60,   // C4
    '87': 61,   // C#4
    '83': 62,   // D4
    '69': 63,   // D#4
    '68': 64,   // E4
    '70': 65,   // F4
    '84': 66,   // F#4
    '71': 67,   // G4
    '89': 68,   // G#4
    '72': 69,   // A4
    '85': 70,   // A#4
    '74': 71,   // B4
    '75': 72    // C5
  };

  window.addEventListener('keydown', this.onKeyDown.bind(this));
  window.addEventListener('keyup', this.onKeyUp.bind(this));
}

KeyEventHandler.prototype.onKeyDown = function (event) {
  var keyCode = event.keyCode;
  
  // If the key is already pressed or there is no corresponding MIDI pitch,
  // stop here.
  if (this.KEYS_PRESSED[keyCode] || !this.KEY2PITCH[keyCode])
    return;

  var voice = new Voice(this.context);
  voice.to(this.effect.input);

  var params = {
    intensity: 0.5,
    attack: this.controls.attack.getValue(),
    decay: this.controls.decay.getValue(),
    sustain: this.controls.sustain.getValue()
  };

  voice.setFilter(this.controls.cutoff.getValue(), this.controls.reso.getValue());
  voice.noteOn(this.KEY2PITCH[keyCode] - 12, params);

  this.KEYS_PRESSED[keyCode] = voice;
};

KeyEventHandler.prototype.onKeyUp = function (event) {
  if (!this.KEYS_PRESSED[event.keyCode])
    return;

  this.KEYS_PRESSED[event.keyCode].noteOff(this.controls.release.getValue());
  this.KEYS_PRESSED[event.keyCode] = null;
};


// Entry point.
window.addEventListener('WebComponentsReady', function () {

  var audioContext = new AudioContext();

  
  // We cannot bind these knobs to AudioParam because AudioNodes are being
  // created dynamically. These parameters will be set at the onset of note.
  var knobs = {
    cutoff: document.getElementById('k-cutoff'),
    reso: document.getElementById('k-reso'),
    attack: document.getElementById('k-attack'),
    decay: document.getElementById('k-decay'),
    sustain: document.getElementById('k-sustain'),
    release: document.getElementById('k-release'),
    mix: document.getElementById('k-mix'),
    delay: document.getElementById('k-delay'),
    feedback: document.getElementById('k-feedback'),
  };

  var echo = new EchoProcessor(audioContext);
  echo.to(audioContext.destination);

  knobs.mix.bind(echo.wet.gain);
  knobs.delay.bind(echo.dly.delayTime);
  knobs.feedback.bind(echo.fbk.gain);

  var keyEventHandler = new KeyEventHandler(audioContext, echo, knobs);

});
</script>

</body>

</html>